import streamlit as st
import numpy as np
import pandas as pd
import joblib

# ============================================================================
# 1. 模型加载与页面配置
# ============================================================================

# 加载模型
model_path = "stacking_Classifier_model.pkl"
try:
    stacking_classifier = joblib.load(model_path)
    st.success("✓ 模型加载成功")
except FileNotFoundError:
    st.error("⚠️ 模型文件未找到，请确保 stacking_Classifier_model.pkl 在同一目录下")
    st.stop()
except Exception as e:
    st.error(f"⚠️ 模型加载失败: {e}")
    st.stop()

# 设置页面配置
st.set_page_config(
    layout="wide", 
    page_title="AECOPD亚型预测系统", 
    page_icon="🏥"
)

# ============================================================================
# 2. 亚型信息定义
# ============================================================================

SUBTYPE_INFO = {
    1: {
        "name": "亚型1",
        "full_name": "精神萎靡合并苔白型",
        "readmission_rate": 14.62,
        "risk_level": "中风险",
        "risk_color": "🟡",
        "main_features": "精神萎靡（100.00%）+ 苔白（99.42%）",
        "secondary_features": "痰热壅肺证罕见（1.75%），病程≥10年比例最低（20.47%），C反应蛋白升高比例较低（42.11%）"
    },
    2: {
        "name": "亚型2",
        "full_name": "精神萎靡主导型",
        "readmission_rate": 20.65,
        "risk_level": "高风险",
        "risk_color": "🔴",
        "main_features": "精神萎靡为主要表现（86.45%）",
        "secondary_features": "仅11.61%出现苔白，16.77%出现痰热壅肺证，C反应蛋白升高比例最低（36.13%），FVC%正常比例较高（59.35%）"
    },
    3: {
        "name": "亚型3",
        "full_name": "中医特征不显型",
        "readmission_rate": 12.27,
        "risk_level": "低风险",
        "risk_color": "🟢",
        "main_features": "中医特征不明显（人数最多）",
        "secondary_features": "痰热壅肺证（7.44%）、精神萎靡（0.40%）、苔白（13.68%）发生率均较低，红细胞计数偏低比例最高（64.99%），血小板分布宽度偏低比例最高（38.63%）"
    },
    4: {
        "name": "亚型4",
        "full_name": "痰热壅肺证主导型",
        "readmission_rate": 11.19,
        "risk_level": "低风险",
        "risk_color": "🟢",
        "main_features": "痰热壅肺证为主要特征（82.31%）",
        "secondary_features": "精神萎靡（1.08%）和苔白（6.14%）发生率极低，FVC%正常比例最高（61.37%），超重及肥胖比例合计较高（50.54%）"
    },
    5: {
        "name": "亚型5",
        "full_name": "苔白主导型",
        "readmission_rate": 12.78,
        "risk_level": "低风险",
        "risk_color": "🟢",
        "main_features": "苔白为主要特征（78.95%）",
        "secondary_features": "痰热壅肺证（3.01%）和精神萎靡（0%）发生率极低，FEV1/FVC重度受损比例最高（56.39%），中性粒细胞偏高比例最高（27.82%），单核细胞偏高比例最高（22.93%）"
    },
    6: {
        "name": "亚型6",
        "full_name": "痰热壅肺证合并精神萎靡型",
        "readmission_rate": 17.06,
        "risk_level": "中风险",
        "risk_color": "🟡",
        "main_features": "痰热壅肺证（90.00%）+ 精神萎靡（97.65%）",
        "secondary_features": "仅4.71%出现苔白，红细胞计数偏高比例最高（15.29%），总蛋白正常比例最高（82.35%）"
    }
}

# ============================================================================
# 3. 页面标题
# ============================================================================

st.title("🏥 AECOPD出院后1年内急性加重再住院亚型预测系统")
st.write("""
基于Stacking集成学习模型，预测AECOPD患者出院后1年内急性加重再住院的**6个亚型**。
本系统整合了**6个关键临床特征**（3项中医证候 + 3项理化指标），为临床决策提供辅助支持。
""")

# ============================================================================
# 4. 侧边栏输入区域
# ============================================================================

st.sidebar.header("📋 临床特征输入")
st.sidebar.write("请输入患者的6项关键临床特征：")

# 中医特征（3项）
st.sidebar.subheader("中医特征 (3项)")

tan_re = st.sidebar.selectbox(
    "痰热壅肺证", 
    options=[0, 1],
    format_func=lambda x: "无" if x == 0 else "有",
    help="""
    中医辨证是否为痰热壅肺证。
    
    诊断标准（李建生等. 中华中医药杂志, 2010）：
    - 主症：咳嗽或喘息；痰黏、色黄，咯痰不爽
    - 次症：发热或口渴喜冷饮；大便干结；舌质红，舌苔黄或黄腻，脉数或滑数
    - 具备主症2项 + 次症中2项可诊断
    """
)

jing_shen_wei_mi = st.sidebar.selectbox(
    "精神萎靡", 
    options=[0, 1],
    format_func=lambda x: "无" if x == 0 else "有",
    help="患者是否出现精神萎靡症状（精神不振、倦怠乏力、反应迟钝等）"
)

tai_bai = st.sidebar.selectbox(
    "苔白", 
    options=[0, 1],
    format_func=lambda x: "无" if x == 0 else "有",
    help="舌苔是否呈白色（中医望诊）"
)

# 理化指标（3项）
st.sidebar.subheader("理化指标 (3项)")

hdl_c = st.sidebar.selectbox(
    "高密度脂蛋白胆固醇 (HDL-C)", 
    options=[1, 2, 3],
    format_func=lambda x: {1: "正常", 2: "偏低", 3: "偏高"}[x],
    help="""
    HDL-C水平分类：
    - 正常：男性1.03-1.55 mmol/L，女性1.16-1.55 mmol/L
    - 偏低：低于正常范围下限
    - 偏高：高于正常范围上限
    
    来源：血脂检查
    """
)

fev1_fvc = st.sidebar.selectbox(
    "FEV1/FVC比值", 
    options=[2, 3, 4],
    format_func=lambda x: {2: "轻度降低 (≥60% 但 <70%)", 
                           3: "中度降低 (≥50% 但 <60%)", 
                           4: "重度降低 (<50%)"}[x],
    help="""
    FEV1/FVC比值分级：
    - 轻度降低：≥60% 但 <70%
    - 中度降低：≥50% 但 <60%
    - 重度降低：<50%
    
    来源：肺功能检查
    临床意义：反映气道阻塞程度
    """
)

pdw = st.sidebar.selectbox(
    "血小板分布宽度 (PDW)", 
    options=[1, 2, 3],
    format_func=lambda x: {1: "正常 (15-17%)", 2: "偏低 (<15%)", 3: "偏高 (>17%)"}[x],
    help="""
    血小板分布宽度分类：
    - 正常：15-17%
    - 偏低：<15%
    - 偏高：>17%
    
    来源：血常规检查
    临床意义：反映血小板大小的异质性
    """
)

# 添加预测按钮
st.sidebar.markdown("---")
predict_button = st.sidebar.button("🔮 开始预测", type="primary", use_container_width=True)

# ============================================================================
# 5. 主页面结果展示
# ============================================================================

if predict_button:
    st.header("📊 预测结果")
    
    try:
        # 构建输入特征数组（按照模型训练时的特征顺序）
        # 特征顺序：痰热壅肺证, 精神萎靡, 苔白, 高密度脂蛋白胆固醇, FEV1/FVC, 血小板分布宽度
        input_array = np.array([
            tan_re,              # 痰热壅肺证
            jing_shen_wei_mi,    # 精神萎靡
            tai_bai,             # 苔白
            hdl_c,               # 高密度脂蛋白胆固醇
            fev1_fvc,            # FEV1/FVC
            pdw                  # 血小板分布宽度
        ]).reshape(1, -1)

        # 模型预测
        prediction = stacking_classifier.predict(input_array)[0]
        prediction_proba = stacking_classifier.predict_proba(input_array)[0]
        
        # 预测结果（亚型编号1-6）
        predicted_subtype = prediction
        predicted_proba = prediction_proba[predicted_subtype - 1]  # 概率数组索引从0开始

        # ========================================================================
        # 5.1 核心预测结果展示
        # ========================================================================
        col1, col2, col3 = st.columns([1, 1, 1])
        
        with col1:
            st.success(f"### 预测亚型")
            st.metric(
                label=f"{SUBTYPE_INFO[predicted_subtype]['name']} - {SUBTYPE_INFO[predicted_subtype]['full_name']}", 
                value=f"预测概率: {predicted_proba*100:.2f}%"
            )
        
        with col2:
            st.info(f"### 1年内急性加重再住院率")
            st.metric(
                label="再住院风险评估", 
                value=f"{SUBTYPE_INFO[predicted_subtype]['readmission_rate']}%"
            )
        
        with col3:
            risk_level = SUBTYPE_INFO[predicted_subtype]['risk_level']
            risk_color = SUBTYPE_INFO[predicted_subtype]['risk_color']
            st.warning("### 风险等级")
            st.metric(
                label="综合评估", 
                value=f"{risk_color} {risk_level}"
            )
        
        # ========================================================================
        # 5.2 临床特征与建议
        # ========================================================================
        st.markdown("---")
        
        col_feature1, col_feature2 = st.columns(2)
        
        with col_feature1:
            st.info(f"""
            **📌 主要特征：**
            
            {SUBTYPE_INFO[predicted_subtype]['main_features']}
            
            **📋 次要特征：**
            
            {SUBTYPE_INFO[predicted_subtype]['secondary_features']}
            """)
        
        with col_feature2:
            st.success(f"""
            **💡 临床建议：**
            
            {SUBTYPE_INFO[predicted_subtype]['clinical_advice']}
            
            **📅 建议随访频率：**
            
            {SUBTYPE_INFO[predicted_subtype]['follow_up']}
            
            **⚠️ 注意事项：**
            
            请结合患者病史、体格检查、影像学检查等综合评估，制定个性化治疗和随访方案。
            """)
        
        st.markdown("---")
        
        # ========================================================================
        # 5.3 各亚型概率分布与再住院率对比
        # ========================================================================
        st.subheader("📈 各亚型预测概率分布与再住院率对比")
        
        col_chart1, col_chart2 = st.columns(2)
        
        with col_chart1:
            st.write("**各亚型预测概率**")
            proba_df = pd.DataFrame({
                '亚型': [f"{SUBTYPE_INFO[i]['name']}\n{SUBTYPE_INFO[i]['full_name']}" for i in range(1, 7)],
                '概率(%)': prediction_proba * 100
            })
            st.bar_chart(proba_df.set_index('亚型'))
        
        with col_chart2:
            st.write("**各亚型再住院率对比**")
            readmission_df = pd.DataFrame({
                '亚型': [f"{SUBTYPE_INFO[i]['name']}\n{SUBTYPE_INFO[i]['full_name']}" for i in range(1, 7)],
                '再住院率(%)': [SUBTYPE_INFO[i]['readmission_rate'] for i in range(1, 7)]
            })
            st.bar_chart(readmission_df.set_index('亚型'))
        
        # ========================================================================
        # 5.4 详细预测概率与再住院率表格
        # ========================================================================
        st.subheader("📋 详细预测概率与再住院率")
        
        proba_table = pd.DataFrame({
            '亚型': [SUBTYPE_INFO[i]['name'] for i in range(1, 7)],
            '亚型名称': [SUBTYPE_INFO[i]['full_name'] for i in range(1, 7)],
            '预测概率': [f"{p*100:.2f}%" for p in prediction_proba],
            '再住院率': [f"{SUBTYPE_INFO[i]['readmission_rate']}%" for i in range(1, 7)],
            '风险等级': [f"{SUBTYPE_INFO[i]['risk_color']} {SUBTYPE_INFO[i]['risk_level']}" for i in range(1, 7)],
            '建议随访': [SUBTYPE_INFO[i]['follow_up'] for i in range(1, 7)]
        })
        
        # 高亮显示预测亚型
        def highlight_predicted(row):
            if row['亚型'] == SUBTYPE_INFO[predicted_subtype]['name']:
                return ['background-color: #90EE90'] * len(row)
            return [''] * len(row)
        
        styled_table = proba_table.style.apply(highlight_predicted, axis=1)
        st.dataframe(styled_table, use_container_width=True)
        
        st.markdown("---")
        
        # ========================================================================
        # 5.5 当前输入特征详细解读
        # ========================================================================
        st.subheader("🔍 当前输入特征详细解读")
        
        col_input1, col_input2 = st.columns(2)
        
        with col_input1:
            st.info(f"""
            **中医特征（3项）：**
            
            1. **痰热壅肺证**
               - 当前状态: **{'有' if tan_re == 1 else '无'}**
               - 临床意义: 中医辨证分型，反映痰热内蕴、壅阻肺络的病理状态
               - 亚型关联: 亚型4和亚型6的关键特征
            
            2. **精神萎靡**
               - 当前状态: **{'有' if jing_shen_wei_mi == 1 else '无'}**
               - 临床意义: 反映患者整体精神状态和生活质量
               - 亚型关联: 亚型1、亚型2和亚型6的关键特征
            
            3. **苔白**
               - 当前状态: **{'有' if tai_bai == 1 else '无'}**
               - 临床意义: 中医舌诊指标，反映体内寒湿或气血亏虚
               - 亚型关联: 亚型1和亚型5的关键特征
            """)
        
        with col_input2:
            hdl_c_status = {1: "正常", 2: "偏低", 3: "偏高"}[hdl_c]
            hdl_c_range = "男性1.03-1.55, 女性1.16-1.55 mmol/L"
            
            fev1_fvc_status = {2: "轻度降低 (≥60% 但 <70%)", 
                               3: "中度降低 (≥50% 但 <60%)", 
                               4: "重度降低 (<50%)"}[fev1_fvc]
            
            pdw_status = {1: "正常 (15-17%)", 2: "偏低 (<15%)", 3: "偏高 (>17%)"}[pdw]
            
            st.info(f"""
            **理化指标（3项）：**
            
            1. **高密度脂蛋白胆固醇 (HDL-C)**
               - 当前状态: **{hdl_c_status}**
               - 正常范围: {hdl_c_range}
               - 临床意义: 心血管保护因子，"好胆固醇"
               - 来源: 血脂检查
            
            2. **FEV1/FVC比值**
               - 当前状态: **{fev1_fvc_status}**
               - 临床意义: 反映气道阻塞程度，COPD诊断和分级的关键指标
               - 来源: 肺功能检查
            
            3. **血小板分布宽度 (PDW)**
               - 当前状态: **{pdw_status}**
               - 正常范围: 15-17%
               - 临床意义: 反映血小板大小的异质性，与炎症和血栓风险相关
               - 来源: 血常规检查
            """)
        
    except Exception as e:
        st.error(f"❌ 预测时发生错误：{e}")
        st.exception(e)

# ============================================================================
# 6. 可折叠信息面板
# ============================================================================

# 输入特征汇总
with st.expander("📝 查看当前输入的特征值"):
    input_summary = pd.DataFrame({
        '特征类别': [
            '中医证候', '中医证候', '中医证候',
            '理化指标', '理化指标', '理化指标'
        ],
        '特征名称': [
            '痰热壅肺证', '精神萎靡', '苔白',
            '高密度脂蛋白胆固醇', 'FEV1/FVC', '血小板分布宽度'
        ],
        '输入值': [
            "有" if tan_re == 1 else "无",
            "有" if jing_shen_wei_mi == 1 else "无",
            "有" if tai_bai == 1 else "无",
            {1: "正常", 2: "偏低", 3: "偏高"}[hdl_c],
            {2: "轻度降低", 3: "中度降低", 4: "重度降低"}[fev1_fvc],
            {1: "正常", 2: "偏低", 3: "偏高"}[pdw]
        ],
        '正常范围/标准': [
            '见中医辨证标准',
            '-',
            '-',
            '男1.03-1.55, 女1.16-1.55 mmol/L',
            '≥70%',
            '15-17%'
        ]
    })
    st.dataframe(input_summary, use_container_width=True)

# 各亚型详细特征
with st.expander("ℹ️ 各亚型详细特征及临床意义"):
    st.markdown("""
    ### 各亚型1年内急性加重再住院率
    
    | 亚型 | 亚型名称 | 再住院率 | 风险等级 | 主要特征 | 建议随访频率 |
    |------|----------|----------|----------|----------|--------------|
    | 亚型1 | 精神萎靡合并苔白型 | 14.62% | 🟡 中风险 | 精神萎靡(100%) + 苔白(99.42%) | 1-2月复诊 |
    | 亚型2 | 精神萎靡主导型 | **20.65%** | 🔴 高风险 | 精神萎靡为主(86.45%) | 2-4周复诊 |
    | 亚型3 | 中医特征不显型 | 12.27% | 🟢 低风险 | 中医特征不明显(人数最多) | 3-6月复诊 |
    | 亚型4 | 痰热壅肺证主导型 | **11.19%** | 🟢 低风险 | 痰热壅肺证为主(82.31%) | 3-6月复诊 |
    | 亚型5 | 苔白主导型 | 12.78% | 🟢 低风险 | 苔白为主(78.95%) | 3-6月复诊 |
    | 亚型6 | 痰热壅肺证合并精神萎靡型 | 17.06% | 🟡 中风险 | 痰热壅肺证(90%) + 精神萎靡(97.65%) | 1-2月复诊 |
    
    ---
    
    ### 各亚型详细特征描述
    
    #### 🟡 亚型1（精神萎靡合并苔白型）- 中风险
    
    **主要特征：**
    - 精神萎靡出现率：100.00%
    - 苔白出现率：99.42%
    - 痰热壅肺证罕见：1.75%
    
    **次要特征：**
    - 病程≥10年比例最低：20.47%
    - C反应蛋白升高比例较低：42.11%
    
    **临床意义：**
    - 以精神萎靡合并苔白为特征，提示气血亏虚、寒湿内蕴
    - 病程相对较短但整体状态较差
    - 需关注患者精神状态和营养支持
    
    ---
    
    #### 🔴 亚型2（精神萎靡主导型）- 高风险
    
    **主要特征：**
    - 精神萎靡为主要表现：86.45%
    - 苔白出现率：11.61%
    - 痰热壅肺证出现率：16.77%
    
    **次要特征：**
    - C反应蛋白升高比例最低：36.13%
    - FVC%正常比例较高：59.35%
    
    **临床意义：**
    - **再住院率最高的亚型（20.65%）**
    - 以精神萎靡为主但中医特征不典型
    - 虽然肺功能相对较好，但整体预后较差
    - **需要密切随访和积极干预**
    
    ---
    
    #### 🟢 亚型3（中医特征不显型）- 低风险
    
    **主要特征：**
    - 中医特征不明显（人数最多的亚型）
    - 痰热壅肺证：7.44%
    - 精神萎靡：0.40%
    - 苔白：13.68%
    
    **次要特征：**
    - 红细胞计数偏低比例最高：64.99%
    - 血小板分布宽度偏低比例最高：38.63%
    
    **临床意义：**
    - 中医证候表现不典型
    - 可能存在贫血和血液系统异常
    - 预后相对较好，但需关注血液指标
    
    ---
    
    #### 🟢 亚型4（痰热壅肺证主导型）- 低风险
    
    **主要特征：**
    - 痰热壅肺证为主要特征：82.31%
    - 精神萎靡发生率极低：1.08%
    - 苔白发生率极低：6.14%
    
    **次要特征：**
    - FVC%正常比例最高：61.37%
    - 超重及肥胖比例合计较高：50.54%
    
    **临床意义：**
    - **再住院率最低的亚型（11.19%）**
    - 痰热壅肺证明显但精神状态良好
    - 肺功能相对较好
    - 需要控制体重，加强肺康复训练
    
    ---
    
    #### 🟢 亚型5（苔白主导型）- 低风险
    
    **主要特征：**
    - 苔白为主要特征：78.95%
    - 痰热壅肺证发生率极低：3.01%
    - 精神萎靡发生率极低：0%
    
    **次要特征：**
    - FEV1/FVC重度受损比例最高：56.39%
    - 中性粒细胞偏高比例最高：27.82%
    - 单核细胞偏高比例最高：22.93%
    
    **临床意义：**
    - 以苔白为主，提示寒湿内蕴
    - 气道阻塞严重但精神状态良好
    - 炎症指标升高，需关注感染风险
    
    ---
    
    #### 🟡 亚型6（痰热壅肺证合并精神萎靡型）- 中风险
    
    **主要特征：**
    - 痰热壅肺证：90.00%
    - 精神萎靡：97.65%
    - 苔白出现率低：4.71%
    
    **次要特征：**
    - 红细胞计数偏高比例最高：15.29%
    - 总蛋白正常比例最高：82.35%
    
    **临床意义：**
    - 痰热壅肺证合并精神萎靡，证候复杂
    - 再住院率较高（17.06%）
    - 需要中西医结合治疗
    
    ---
    
    ### 注意事项
    
    ⚠️ **重要提示：**
    - 本预测结果仅供临床参考，不能替代医生的专业判断
    - 建议结合患者的病史、体格检查、影像学检查等综合评估
    - 对于高风险患者（亚型2），应制定个性化的随访和治疗方案
    - 中医证候的判断建议由专业中医师进行
    
    📋 **所有患者的通用建议：**
    - 戒烟，避免二手烟暴露
    - 避免接触有害气体和粉尘
    - 接种流感疫苗和肺炎疫苗
    - 规律使用吸入药物（支气管扩张剂、糖皮质激素等）
    - 进行肺康复训练（呼吸训练、运动训练、营养支持）
    - 保持良好的营养状态
    - 及时就医，预防急性加重
    - 对于中医证候明显的患者，可考虑中西医结合治疗
    """)

# 使用说明
with st.expander("📖 使用说明"):
    st.markdown("""
    ### 如何使用本系统
    
    #### 第一步：输入特征值
    
    在左侧边栏依次输入患者的**6项关键临床特征**：
    
    **中医特征（3项）：**
    1. **痰热壅肺证** - 选择"无"或"有"
       - 需由中医师辨证或参考诊断标准
       - 主要表现：咳嗽、喘息、痰黄黏稠、舌红苔黄等
    
    2. **精神萎靡** - 选择"无"或"有"
       - 观察患者精神状态
       - 表现：精神不振、倦怠乏力、反应迟钝等
    
    3. **苔白** - 选择"无"或"有"
       - 通过舌诊观察
       - 舌苔呈白色
    
    **理化指标（3项）：**
    4. **高密度脂蛋白胆固醇 (HDL-C)** - 选择"正常"、"偏低"或"偏高"
       - 来源：血脂检查报告
       - 参考范围：男性1.03-1.55 mmol/L，女性1.16-1.55 mmol/L
    
    5. **FEV1/FVC比值** - 选择"轻度降低"、"中度降低"或"重度降低"
       - 来源：肺功能检查报告
       - 轻度降低：≥60% 但 <70%
       - 中度降低：≥50% 但 <60%
       - 重度降低：<50%
    
    6. **血小板分布宽度 (PDW)** - 选择"正常"、"偏低"或"偏高"
       - 来源：血常规检查报告
       - 正常范围：15-17%
    
    #### 第二步：开始预测
    
    点击左侧边栏底部的 **"🔮 开始预测"** 按钮
    
    #### 第三步：查看结果
    
    系统将显示以下内容：
    - ✅ 预测亚型及概率
    - ✅ 1年内再住院风险评估
    - ✅ 风险等级评定
    - ✅ 主要和次要临床特征
    - ✅ 详细的临床建议和随访计划
    - ✅ 各亚型概率分布图和再住院率对比
    - ✅ 当前输入特征的详细解读
    
    #### 第四步：临床决策
    
    根据预测结果，结合患者实际情况：
    - 制定个性化治疗方案
    - 安排合理的随访计划
    - 进行针对性的健康教育
    - 实施预防性干预措施
    - 对于高风险患者（特别是亚型2），需要密切随访和积极干预
    
    ---
    
    ### 模型性能指标
    
    本模型在数据集上进行了严格验证：
    
    | 数据集 | Micro-AUC | Macro-AUC | 样本量 |
    |--------|-----------|-----------|--------|
    | 训练集 | 0.979 | 0.969 | 908例 |
    | 测试集 | 0.938 | 0.904 | 389例 |
    | 时段验证集 | 0.927 | 0.925 | 239例 |
    
    **性能评价：**
    - 训练集AUC接近0.98，说明模型拟合良好
    - 测试集AUC为0.938，表明模型泛化能力强
    - 时段验证集AUC为0.927，证明模型在不同时段数据上表现稳定
    - Micro-AUC和Macro-AUC接近，表明模型对各亚型预测均衡
    - **综合评价：模型性能优秀，可用于临床辅助决策**
    
    ---
    
    ### 特征获取指南
    
    #### 中医证候如何判断：
    
    1. **痰热壅肺证**
       - **建议由专业中医师辨证**
       - 参考诊断标准（李建生等. 中华中医药杂志, 2010.25(7):971-975）：
         - 主症：①咳嗽或喘息；②痰黏、色黄，咯痰不爽
         - 次症：③发热或口渴喜冷饮；④大便干结；⑤舌质红，舌苔黄或黄腻或黄厚腻，脉数或滑数
         - **诊断：具备主症2项 + 次症中2项**
    
    2. **精神萎靡**
       - 观察患者整体精神状态
       - 主要表现：精神不振、倦怠乏力、反应迟钝、少言懒动等
       - 可通过患者主诉和家属描述综合判断
    
    3. **苔白**
       - 通过中医舌诊观察
       - 舌苔颜色呈白色（区别于黄苔、无苔等）
       - 可拍照记录或请中医师协助判断
    
    #### 理化指标如何获取：
    
    1. **高密度脂蛋白胆固醇 (HDL-C)**
       - **来源：血脂检查**
       - 英文名：High-Density Lipoprotein Cholesterol
       - 单位：mmol/L
       - 分类标准：
         - 正常：男性1.03-1.55 mmol/L，女性1.16-1.55 mmol/L
         - 偏低：低于正常范围下限
         - 偏高：高于正常范围上限
    
    2. **FEV1/FVC比值**
       - **来源：肺功能检查**
       - 英文名：FEV1/FVC Ratio
       - 单位：%
       - 分级标准：
         - 轻度降低：≥60% 但 <70%
         - 中度降低：≥50% 但 <60%
         - 重度降低：<50%
       - 临床意义：反映气道阻塞程度，是COPD诊断和分级的关键指标
    
    3. **血小板分布宽度 (PDW)**
       - **来源：血常规检查**
       - 英文名：Platelet Distribution Width
       - 单位：%
       - 分类标准：
         - 正常：15-17%
         - 偏低：<15%
         - 偏高：>17%
       - 临床意义：反映血小板大小的异质性，与炎症和血栓风险相关
    
    ---
    
    ### 技术支持
    
    如有任何问题或建议，请联系：
    - 📧 邮箱：[wangj1758@163.com]
    - 📱 电话：[1573196323]
    - 🏥 科室：[呼吸科]
    
    ---
    
    ### 参考文献
    
    1. 李建生, 等. 慢性阻塞性肺疾病中医证候诊断标准（2008年版）[J]. 中华中医药杂志, 2010, 25(7): 971-975.
    2. 中华医学会呼吸病学分会慢性阻塞性肺疾病学组. 慢性阻塞性肺疾病诊治指南（2021年修订版）[J]. 中华结核和呼吸杂志, 2021, 44(3): 170-205.
    """)

# ============================================================================
# 7. 侧边栏信息面板
# ============================================================================

# 模型信息
st.sidebar.markdown("---")
st.sidebar.info("""
**模型信息**

- **模型类型**：Stacking集成学习
- **基学习器**：RF, XGB, LGBM, GBM, AdaBoost, CatBoost
- **元学习器**：Logistic Regression
- **特征数量**：6个关键特征
  - 中医证候：3项
  - 理化指标：3项
- **预测类别**：6个亚型
- **性能指标**：
  - 训练集 Micro-AUC: 0.979
  - 测试集 Micro-AUC: 0.938
  - 时段验证集 Micro-AUC: 0.927
""")

# 快速参考卡片
st.sidebar.markdown("---")
st.sidebar.success("""
**风险等级快速参考**

🔴 **高风险 (亚型2)**
- 再住院率：**20.65%**
- 主要特征：精神萎靡主导型
- 建议：2-4周复诊

🟡 **中风险 (亚型1、6)**
- 再住院率：14.62%、17.06%
- 建议：1-2月复诊

🟢 **低风险 (亚型3、4、5)**
- 再住院率：11.19%-12.78%
- 建议：3-6月复诊
""")

# 页脚
st.markdown("---")
st.markdown("""
<div style='text-align: center'>
    <p><strong>⚕️ AECOPD亚型预测系统</strong></p>
    <p>基于Stacking集成学习的临床决策支持工具</p>
    <p style='font-size: 12px; color: gray; margin-top: 10px;'>
        <strong>免责声明：</strong>本系统仅供研究和辅助决策使用，不能替代专业医疗建议。<br>
        所有预测结果应由专业医生结合临床实际情况进行综合判断。<br>
        中医证候的判断建议由专业中医师进行。
    </p>
    <p style='font-size: 10px; color: gray; margin-top: 5px;'>
        版本: V1.0 | 更新日期: 2025-02-04 | 特征: 6个 | 亚型: 6个
    </p>
</div>
""", unsafe_allow_html=True)