import streamlit as st
import numpy as np
import pandas as pd
import joblib

# åŠ è½½æ¨¡å‹
model_path = "stacking_Classifier_model.pkl"
try:
    stacking_classifier = joblib.load(model_path)
except:
    st.error("âš ï¸ æ¨¡å‹æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿ stacking_Classifier_model.pkl åœ¨åŒä¸€ç›®å½•ä¸‹")
    st.stop()

# è®¾ç½®é¡µé¢é…ç½®å’Œæ ‡é¢˜
st.set_page_config(
    layout="wide", 
    page_title="AECOPDäºšå‹é¢„æµ‹ç³»ç»Ÿ", 
    page_icon="ğŸ¥"
)

st.title("ğŸ¥ AECOPDå‡ºé™¢å1å¹´å†…æ€¥æ€§åŠ é‡å†ä½é™¢äºšå‹é¢„æµ‹ç³»ç»Ÿ")
st.write("""
åŸºäºStackingé›†æˆå­¦ä¹ æ¨¡å‹ï¼Œé¢„æµ‹AECOPDæ‚£è€…å‡ºé™¢å1å¹´å†…æ€¥æ€§åŠ é‡å†ä½é™¢çš„4ä¸ªäºšå‹ã€‚
æœ¬ç³»ç»Ÿæ•´åˆäº†**6ä¸ªå…³é”®ä¸´åºŠç‰¹å¾**ï¼Œä¸ºä¸´åºŠå†³ç­–æä¾›è¾…åŠ©æ”¯æŒã€‚
""")

# å·¦ä¾§ä¾§è¾¹æ è¾“å…¥åŒºåŸŸ
st.sidebar.header("ğŸ“‹ ä¸´åºŠç‰¹å¾è¾“å…¥")
st.sidebar.write("è¯·è¾“å…¥æ‚£è€…çš„6é¡¹å…³é”®ä¸´åºŠç‰¹å¾ï¼š")

# å®šä¹‰ç‰¹å¾è¾“å…¥ï¼ˆè¿ç»­å˜é‡ï¼‰
st.sidebar.subheader("ç†åŒ–æŒ‡æ ‡ (4é¡¹)")

MCH = st.sidebar.number_input(
    "å¹³å‡è¡€çº¢è›‹ç™½é‡ (pg)", 
    min_value=18.1, 
    max_value=43.3, 
    value=30.0,
    help="æ­£å¸¸èŒƒå›´: 27-34 pg"
)

apoA = st.sidebar.number_input(
    "è½½è„‚è›‹ç™½A (g/L)", 
    min_value=0.34, 
    max_value=2.61, 
    value=1.2,
    help="æ­£å¸¸èŒƒå›´: 1.0-1.6 g/L"
)

uric_acid = st.sidebar.number_input(
    "å°¿é…¸ (Î¼mol/L)", 
    min_value=71.0, 
    max_value=731.3, 
    value=300.0,
    help="æ­£å¸¸èŒƒå›´: ç”·æ€§208-428, å¥³æ€§155-357 Î¼mol/L"
)

FVC = st.sidebar.number_input(
    "FVCå é¢„è®¡å€¼çš„ç™¾åˆ†æ¯” (%)", 
    min_value=22.92, 
    max_value=139.45, 
    value=80.0,
    help="æ­£å¸¸èŒƒå›´: â‰¥80%"
)

# å®šä¹‰ç‰¹å¾è¾“å…¥ï¼ˆäºŒåˆ†ç±»å˜é‡ï¼‰
st.sidebar.subheader("ä¸­åŒ»è¯å€™ä¿¡æ¯ (2é¡¹)")

fever = st.sidebar.selectbox(
    "å‘çƒ­", 
    options=[0, 1],
    format_func=lambda x: "æ— " if x == 0 else "æœ‰",
    help="æ˜¯å¦å‡ºç°å‘çƒ­ç—‡çŠ¶"
)

tan_re = st.sidebar.selectbox(
    "ç—°çƒ­å£…è‚ºè¯", 
    options=[0, 1],
    format_func=lambda x: "æ— " if x == 0 else "æœ‰",
    help="ä¸­åŒ»è¾¨è¯æ˜¯å¦ä¸ºç—°çƒ­å£…è‚ºè¯"
)

# æ·»åŠ é¢„æµ‹æŒ‰é’®
predict_button = st.sidebar.button("ğŸ”® å¼€å§‹é¢„æµ‹", type="primary")

# ä¸»é¡µé¢ç”¨äºç»“æœå±•ç¤º
if predict_button:
    st.header("ğŸ“Š é¢„æµ‹ç»“æœ")
    
    # æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯å¼€å…³
    show_debug = st.checkbox("ğŸ” æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯", value=True)
    
    try:
        # æ„å»ºè¾“å…¥æ•°ç»„
        input_array = np.array([
            MCH, apoA, uric_acid, FVC, fever, tan_re
        ]).reshape(1, -1)
        
        if show_debug:
            st.subheader("ğŸ› è°ƒè¯•ä¿¡æ¯")
            st.code(f"""
æ¨¡å‹ç±»å‹: {type(stacking_classifier)}
è¾“å…¥å½¢çŠ¶: {input_array.shape}
è¾“å…¥å†…å®¹: {input_array[0]}
ç‰¹å¾é¡ºåº: ['MCH', 'apoA', 'uric_acid', 'FVC', 'fever', 'tan_re']
            """)
        
        # æ¨¡å‹é¢„æµ‹
        prediction = stacking_classifier.predict(input_array)[0]
        prediction_proba = stacking_classifier.predict_proba(input_array)[0]
        max_proba_index = np.argmax(prediction_proba)
        
        if show_debug:
            st.code(f"""
é¢„æµ‹ç±»åˆ«: {prediction}
åŸå§‹æ¦‚ç‡: {prediction_proba}
æ¦‚ç‡æ€»å’Œ: {np.sum(prediction_proba):.6f}
æœ€å¤§æ¦‚ç‡ç´¢å¼•: {max_proba_index}
æœ€å¤§æ¦‚ç‡å€¼: {prediction_proba[max_proba_index]:.6f}
            """)
        
        # æ£€æŸ¥å¼‚å¸¸æƒ…å†µ
        if np.allclose(prediction_proba, prediction_proba[0]):
            st.error("âš ï¸ è­¦å‘Š: æ‰€æœ‰ç±»åˆ«çš„æ¦‚ç‡ç›¸åŒ,æ¨¡å‹å¯èƒ½æœªæ­£ç¡®åŠ è½½!")
        
        if np.sum(prediction_proba) < 0.99 or np.sum(prediction_proba) > 1.01:
            st.error("âš ï¸ è­¦å‘Š: æ¦‚ç‡æ€»å’Œä¸ä¸º1,æ¨¡å‹è¾“å‡ºå¼‚å¸¸!")
        
        # äºšå‹æ˜ å°„åŠ1å¹´å†…æ€¥æ€§åŠ é‡å†ä½é™¢ç‡
        subtype_info = {
            0: {
                "name": "äºšå‹1", 
                "readmission_rate": 19.2, 
                "description": "ç—°çƒ­å£…è‚ºè¯åˆå¹¶å‘çƒ­å‹ - é«˜é£é™©äºšå‹ï¼Œéœ€è¦å¯†åˆ‡éšè®¿å’Œç§¯æå¹²é¢„"
            },
            1: {
                "name": "äºšå‹2", 
                "readmission_rate": 14.5, 
                "description": "æ— ç—°çƒ­å£…è‚ºè¯åŠå‘çƒ­å‹ - ä¸­ç­‰é£é™©äºšå‹ï¼Œå»ºè®®å®šæœŸéšè®¿å’Œé¢„é˜²æ€§æ²»ç–—"
            },
            2: {
                "name": "äºšå‹3", 
                "readmission_rate": 14.0, 
                "description": "å‘çƒ­æ— ç—°çƒ­å£…è‚ºè¯å‹ - ä¸­ç­‰é£é™©äºšå‹ï¼Œå»ºè®®å®šæœŸéšè®¿å’Œé¢„é˜²æ€§æ²»ç–—"
            },
            3: {
                "name": "äºšå‹4", 
                "readmission_rate": 10.1, 
                "description": "ç—°çƒ­å£…è‚ºè¯æ— å‘çƒ­å‹ - ä½é£é™©äºšå‹ï¼Œå»ºè®®å¸¸è§„éšè®¿"
            }
        }

        # æ˜¾ç¤ºé¢„æµ‹ç»“æœï¼ˆä½¿ç”¨æœ€é«˜æ¦‚ç‡çš„äºšå‹ï¼‰
        col1, col2, col3 = st.columns([1, 1, 1])
        
        with col1:
            st.success(f"### é¢„æµ‹äºšå‹ï¼š{subtype_info[max_proba_index]['name']}")
            st.metric(
                label="é¢„æµ‹æ¦‚ç‡", 
                value=f"{prediction_proba[max_proba_index]*100:.2f}%"
            )
        
        with col2:
            st.info(f"### 1å¹´å†…æ€¥æ€§åŠ é‡å†ä½é™¢ç‡")
            st.metric(
                label="å†ä½é™¢é£é™©", 
                value=f"{subtype_info[max_proba_index]['readmission_rate']}%"
            )
        
        with col3:
            st.warning("### é£é™©ç­‰çº§")
            risk_level = "é«˜é£é™©" if subtype_info[max_proba_index]['readmission_rate'] >= 15 else "ä¸­ä½é£é™©"
            risk_color = "ğŸ”´" if risk_level == "é«˜é£é™©" else "ğŸŸ¡"
            st.metric(
                label="è¯„ä¼°", 
                value=f"{risk_color} {risk_level}"
            )
        
        # ä¸´åºŠå»ºè®®
        st.info(f"**ä¸´åºŠå»ºè®®ï¼š** {subtype_info[max_proba_index]['description']}")
        
        st.markdown("---")
        
        # å„äºšå‹æ¦‚ç‡åˆ†å¸ƒ
        st.subheader("ğŸ“ˆ å„äºšå‹é¢„æµ‹æ¦‚ç‡åˆ†å¸ƒ")
        col_chart1, col_chart2 = st.columns(2)
        
        with col_chart1:
            st.write("**å„äºšå‹é¢„æµ‹æ¦‚ç‡**")
            proba_df = pd.DataFrame({
                'äºšå‹': [subtype_info[i]['name'] for i in range(len(prediction_proba))],
                'æ¦‚ç‡(%)': prediction_proba * 100
            })
            st.bar_chart(proba_df.set_index('äºšå‹'))
        
        with col_chart2:
            st.write("**å„äºšå‹å†ä½é™¢ç‡å¯¹æ¯”**")
            readmission_df = pd.DataFrame({
                'äºšå‹': [subtype_info[i]['name'] for i in range(4)],
                'å†ä½é™¢ç‡(%)': [subtype_info[i]['readmission_rate'] for i in range(4)]
            })
            st.bar_chart(readmission_df.set_index('äºšå‹'))
        
        # è¯¦ç»†æ¦‚ç‡è¡¨æ ¼
        st.subheader("ğŸ“‹ è¯¦ç»†é¢„æµ‹æ¦‚ç‡ä¸å†ä½é™¢ç‡")
        proba_table = pd.DataFrame({
            'äºšå‹': [subtype_info[i]['name'] for i in range(len(prediction_proba))],
            'é¢„æµ‹æ¦‚ç‡': [f"{p*100:.2f}%" for p in prediction_proba],
            '1å¹´å†…æ€¥æ€§åŠ é‡å†ä½é™¢ç‡': [f"{subtype_info[i]['readmission_rate']}%" for i in range(4)],
            'é£é™©ç­‰çº§': ['é«˜é£é™©' if subtype_info[i]['readmission_rate'] >= 15 else 'ä¸­ä½é£é™©' for i in range(4)],
            'ä¸´åºŠå»ºè®®': [subtype_info[i]['description'] for i in range(4)]
        })
        
        # é«˜äº®æ˜¾ç¤ºé¢„æµ‹äºšå‹
        def highlight_predicted(row):
            if row['äºšå‹'] == subtype_info[max_proba_index]['name']:
                return ['background-color: #90EE90'] * len(row)
            return [''] * len(row)
        
        styled_table = proba_table.style.apply(highlight_predicted, axis=1)
        st.dataframe(styled_table, use_container_width=True)
        
        st.markdown("---")
        
        # ç‰¹å¾é‡è¦æ€§æç¤º
        st.subheader("ğŸ” å…³é”®ç‰¹å¾è¯´æ˜")
        
        col_feature1, col_feature2 = st.columns(2)
        
        with col_feature1:
            st.info("""
            **ç†åŒ–æŒ‡æ ‡ï¼ˆ4é¡¹ï¼‰ï¼š**
            
            1. **å¹³å‡è¡€çº¢è›‹ç™½é‡ (MCH)**
               - å½“å‰å€¼: {:.2f} pg
               - æ­£å¸¸èŒƒå›´: 27-34 pg
               - ä¸´åºŠæ„ä¹‰: åæ˜ çº¢ç»†èƒæºæ°§èƒ½åŠ›
            
            2. **è½½è„‚è›‹ç™½A (ApoA)**
               - å½“å‰å€¼: {:.2f} g/L
               - æ­£å¸¸èŒƒå›´: 1.0-1.6 g/L
               - ä¸´åºŠæ„ä¹‰: å¿ƒè¡€ç®¡ä¿æŠ¤å› å­
            
            3. **å°¿é…¸**
               - å½“å‰å€¼: {:.2f} Î¼mol/L
               - æ­£å¸¸èŒƒå›´: ç”·æ€§208-428, å¥³æ€§155-357
               - ä¸´åºŠæ„ä¹‰: ä»£è°¢æŒ‡æ ‡ï¼Œç‚ç—‡æ ‡å¿—ç‰©
            
            4. **FVCå é¢„è®¡å€¼çš„ç™¾åˆ†æ¯”**
               - å½“å‰å€¼: {:.2f}%
               - æ­£å¸¸èŒƒå›´: â‰¥80%
               - ä¸´åºŠæ„ä¹‰: è‚ºåŠŸèƒ½é€šæ°”å‚¨å¤‡èƒ½åŠ›
            """.format(MCH, apoA, uric_acid, FVC))
        
        with col_feature2:
            st.info("""
            **ä¸­åŒ»è¯å€™ä¿¡æ¯ï¼ˆ2é¡¹ï¼‰ï¼š**
            
            1. **å‘çƒ­**
               - å½“å‰çŠ¶æ€: {}
               - ä¸´åºŠæ„ä¹‰: æ€¥æ€§æ„ŸæŸ“æ ‡å¿—
               - äºšå‹å…³è”: äºšå‹1å’Œäºšå‹3çš„å…³é”®ç‰¹å¾
            
            2. **ç—°çƒ­å£…è‚ºè¯**
               - å½“å‰çŠ¶æ€: {}
               - ä¸´åºŠæ„ä¹‰: ä¸­åŒ»è¾¨è¯åˆ†å‹
               - äºšå‹å…³è”: äºšå‹1å’Œäºšå‹4çš„å…³é”®ç‰¹å¾
            
            ---
            
            **äºšå‹å¿«é€Ÿè¯†åˆ«ï¼š**
            - å‘çƒ­(+) + ç—°çƒ­å£…è‚ºè¯(+) â†’ å€¾å‘äºšå‹1 (é«˜é£é™©)
            - å‘çƒ­(-) + ç—°çƒ­å£…è‚ºè¯(-) â†’ å€¾å‘äºšå‹2
            - å‘çƒ­(+) + ç—°çƒ­å£…è‚ºè¯(-) â†’ å€¾å‘äºšå‹3
            - å‘çƒ­(-) + ç—°çƒ­å£…è‚ºè¯(+) â†’ å€¾å‘äºšå‹4 (ä½é£é™©)
            """.format(
                "æœ‰" if fever == 1 else "æ— ",
                "æœ‰" if tan_re == 1 else "æ— "
            ))
        
    except Exception as e:
        st.error(f"âŒ é¢„æµ‹æ—¶å‘ç”Ÿé”™è¯¯ï¼š{e}")
        st.exception(e)

# è¾“å…¥ç‰¹å¾æ±‡æ€»
with st.expander("ğŸ“ æŸ¥çœ‹å½“å‰è¾“å…¥çš„ç‰¹å¾å€¼"):
    input_summary = pd.DataFrame({
        'ç‰¹å¾åç§°': [
            'å¹³å‡è¡€çº¢è›‹ç™½é‡', 
            'è½½è„‚è›‹ç™½A', 
            'å°¿é…¸', 
            'FVCå é¢„è®¡å€¼çš„ç™¾åˆ†æ¯”',
            'å‘çƒ­', 
            'ç—°çƒ­å£…è‚ºè¯'
        ],
        'è¾“å…¥å€¼': [
            f"{MCH:.2f}",
            f"{apoA:.2f}",
            f"{uric_acid:.2f}",
            f"{FVC:.2f}",
            "æœ‰" if fever == 1 else "æ— ",
            "æœ‰" if tan_re == 1 else "æ— "
        ],
        'å•ä½': [
            'pg',
            'g/L',
            'Î¼mol/L',
            '%',
            '-',
            '-'
        ],
        'æ­£å¸¸èŒƒå›´': [
            '27-34',
            '1.0-1.6',
            'ç”·208-428/å¥³155-357',
            'â‰¥80',
            '-',
            '-'
        ]
    })
    st.dataframe(input_summary, use_container_width=True)

# äºšå‹ç‰¹å¾è¯´æ˜
with st.expander("â„¹ï¸ å„äºšå‹ç‰¹å¾åŠä¸´åºŠæ„ä¹‰"):
    st.markdown("""
    ### å„äºšå‹1å¹´å†…æ€¥æ€§åŠ é‡å†ä½é™¢ç‡
    
    | äºšå‹ | å†ä½é™¢ç‡ | é£é™©ç­‰çº§ | ä¸»è¦ç‰¹å¾ | ä¸´åºŠå»ºè®® |
    |------|----------|----------|----------|----------|
    | äºšå‹1 | **19.2%** | ğŸ”´ é«˜é£é™© | ç—°çƒ­å£…è‚ºè¯(+) + å‘çƒ­(+) | éœ€è¦å¯†åˆ‡éšè®¿å’Œç§¯æå¹²é¢„ï¼Œå»ºè®®2-4å‘¨å¤è¯Š |
    | äºšå‹2 | 14.5% | ğŸŸ¡ ä¸­ç­‰é£é™© | ç—°çƒ­å£…è‚ºè¯(-) + å‘çƒ­(-) | å®šæœŸéšè®¿å’Œé¢„é˜²æ€§æ²»ç–—ï¼Œå»ºè®®1-2æœˆå¤è¯Š |
    | äºšå‹3 | 14.0% | ğŸŸ¡ ä¸­ç­‰é£é™© | ç—°çƒ­å£…è‚ºè¯(-) + å‘çƒ­(+) | å®šæœŸéšè®¿å’Œé¢„é˜²æ€§æ²»ç–—ï¼Œå»ºè®®1-2æœˆå¤è¯Š |
    | äºšå‹4 | **10.1%** | ğŸŸ¢ ä½é£é™© | ç—°çƒ­å£…è‚ºè¯(+) + å‘çƒ­(-) | å¸¸è§„éšè®¿ï¼Œå»ºè®®3-6æœˆå¤è¯Š |
    
    ### å„äºšå‹è¯¦ç»†ç‰¹å¾
    
    #### ğŸ”´ äºšå‹1ï¼ˆç—°çƒ­å£…è‚ºè¯åˆå¹¶å‘çƒ­å‹ï¼‰- é«˜é£é™©
    **ä¸»è¦ç‰¹å¾ï¼š**
    - å‡ºç°å‘çƒ­åŠç—°çƒ­å£…è‚ºè¯çš„æ¦‚ç‡é«˜è¾¾98%ä»¥ä¸Š
    - å¹³å‡è¡€çº¢è›‹ç™½é‡æ°´å¹³åä½
    - è¡€å°æ¿æ°´å¹³åé«˜
    - å­˜åœ¨é™åˆ¶æ€§é€šæ°”åŠŸèƒ½éšœç¢
    
    **ä¸´åºŠè¡¨ç°ï¼š**
    - å’³å—½ã€å’³ç—°ã€æ°”ä¿ƒ
    - å‘çƒ­ï¼Œä½“æ¸©å‡é«˜
    - ç—°è‰²é»„ç¨ ï¼Œä¸æ˜“å’³å‡º
    - èƒ¸é—·ã€å–˜æ¯
    
    ---
    
    #### ğŸŸ¡ äºšå‹2ï¼ˆæ— ç—°çƒ­å£…è‚ºè¯åŠå‘çƒ­å‹ï¼‰- ä¸­ç­‰é£é™©
    **ä¸»è¦ç‰¹å¾ï¼š**
    - æ— å‘çƒ­åŠç—°çƒ­å£…è‚ºè¯
    - å¹´é¾„åŠæ”¶ç¼©å‹æ°´å¹³åé«˜
    - å­˜åœ¨é™åˆ¶æ€§é€šæ°”åŠŸèƒ½éšœç¢
    
    **ä¸´åºŠè¡¨ç°ï¼š**
    - æ…¢æ€§å’³å—½ã€å’³ç—°
    - æ´»åŠ¨åæ°”ä¿ƒ
    - ä½“æ¸©æ­£å¸¸
    - ç—°è‰²ç™½æˆ–æ¸…
    
    ---
    
    #### ğŸŸ¡ äºšå‹3ï¼ˆå‘çƒ­æ— ç—°çƒ­å£…è‚ºè¯å‹ï¼‰- ä¸­ç­‰é£é™©
    **ä¸»è¦ç‰¹å¾ï¼š**
    - å‡ºç°å‘çƒ­ä½†æœªè¯Šæ–­ä¸ºç—°çƒ­å£…è‚ºè¯
    - å¹´é¾„åé«˜
    - ä½“é‡ã€è½½è„‚è›‹ç™½AåŠå°¿é…¸æ°´å¹³åä½
    - å­˜åœ¨é™åˆ¶æ€§é€šæ°”åŠŸèƒ½éšœç¢
    
    **ä¸´åºŠè¡¨ç°ï¼š**
    - å‘çƒ­ï¼Œä½†çƒ­åŠ¿è¾ƒè½»
    - å’³å—½ã€å’³ç—°
    - æ°”ä¿ƒã€ä¹åŠ›
    - è¥å…»çŠ¶å†µæ¬ ä½³
    
    ---
    
    #### ğŸŸ¢ äºšå‹4ï¼ˆç—°çƒ­å£…è‚ºè¯æ— å‘çƒ­å‹ï¼‰- ä½é£é™©
    **ä¸»è¦ç‰¹å¾ï¼š**
    - è¯Šæ–­ä¸ºç—°çƒ­å£…è‚ºè¯ä½†æ— å‘çƒ­
    - ä½“é‡åŠå°¿é…¸æ°´å¹³åé«˜
    - æ— é™åˆ¶æ€§é€šæ°”åŠŸèƒ½éšœç¢
    
    **ä¸´åºŠè¡¨ç°ï¼š**
    - å’³å—½ã€å’³é»„ç—°
    - ä½“æ¸©æ­£å¸¸
    - æ°”ä¿ƒç›¸å¯¹è¾ƒè½»
    - ä½“é‡è¾ƒé«˜ï¼Œå¯èƒ½åˆå¹¶ä»£è°¢ç»¼åˆå¾
    
    ---
    
    ### æ³¨æ„äº‹é¡¹
    
    âš ï¸ **é‡è¦æç¤ºï¼š**
    - æœ¬é¢„æµ‹ç»“æœä»…ä¾›ä¸´åºŠå‚è€ƒï¼Œä¸èƒ½æ›¿ä»£åŒ»ç”Ÿçš„ä¸“ä¸šåˆ¤æ–­
    - å»ºè®®ç»“åˆæ‚£è€…çš„ç—…å²ã€ä½“æ ¼æ£€æŸ¥ã€å½±åƒå­¦æ£€æŸ¥ç­‰ç»¼åˆè¯„ä¼°
    - å¯¹äºé«˜é£é™©æ‚£è€…ï¼Œåº”åˆ¶å®šä¸ªæ€§åŒ–çš„éšè®¿å’Œæ²»ç–—æ–¹æ¡ˆ
    
    ğŸ“‹ **æ‰€æœ‰æ‚£è€…çš„é€šç”¨å»ºè®®ï¼š**
    - æˆ’çƒŸï¼Œé¿å…äºŒæ‰‹çƒŸ
    - é¿å…æ¥è§¦æœ‰å®³æ°”ä½“å’Œç²‰å°˜
    - æ¥ç§æµæ„Ÿç–«è‹—å’Œè‚ºç‚ç–«è‹—
    - è§„å¾‹ä½¿ç”¨å¸å…¥è¯ç‰©
    - è¿›è¡Œè‚ºåº·å¤è®­ç»ƒ
    - ä¿æŒè‰¯å¥½çš„è¥å…»çŠ¶æ€
    - åŠæ—¶å°±åŒ»ï¼Œé¢„é˜²æ€¥æ€§åŠ é‡
    """)

# ä½¿ç”¨è¯´æ˜
with st.expander("ğŸ“– ä½¿ç”¨è¯´æ˜"):
    st.markdown("""
    ### å¦‚ä½•ä½¿ç”¨æœ¬ç³»ç»Ÿ
    
    #### ç¬¬ä¸€æ­¥ï¼šè¾“å…¥ç‰¹å¾å€¼
    åœ¨å·¦ä¾§è¾¹æ ä¾æ¬¡è¾“å…¥æ‚£è€…çš„**6é¡¹å…³é”®ä¸´åºŠç‰¹å¾**ï¼š
    
    **ç†åŒ–æŒ‡æ ‡ï¼ˆ4é¡¹ï¼‰ï¼š**
    1. å¹³å‡è¡€çº¢è›‹ç™½é‡ (pg) - è¾“å…¥å…·ä½“æ•°å€¼
    2. è½½è„‚è›‹ç™½A (g/L) - è¾“å…¥å…·ä½“æ•°å€¼
    3. å°¿é…¸ (Î¼mol/L) - è¾“å…¥å…·ä½“æ•°å€¼
    4. FVCå é¢„è®¡å€¼çš„ç™¾åˆ†æ¯” (%) - è¾“å…¥å…·ä½“æ•°å€¼
    
    **ä¸­åŒ»è¯å€™ä¿¡æ¯ï¼ˆ2é¡¹ï¼‰ï¼š**
    5. å‘çƒ­ - é€‰æ‹©"æ— "æˆ–"æœ‰"
    6. ç—°çƒ­å£…è‚ºè¯ - é€‰æ‹©"æ— "æˆ–"æœ‰"
    
    #### ç¬¬äºŒæ­¥ï¼šå¼€å§‹é¢„æµ‹
    ç‚¹å‡»å·¦ä¾§è¾¹æ åº•éƒ¨çš„ **"ğŸ”® å¼€å§‹é¢„æµ‹"** æŒ‰é’®
    
    #### ç¬¬ä¸‰æ­¥ï¼šæŸ¥çœ‹ç»“æœ
    ç³»ç»Ÿå°†æ˜¾ç¤ºä»¥ä¸‹å†…å®¹ï¼š
    - âœ… é¢„æµ‹äºšå‹åŠæ¦‚ç‡
    - âœ… 1å¹´å†…å†ä½é™¢é£é™©è¯„ä¼°
    - âœ… å„äºšå‹æ¦‚ç‡åˆ†å¸ƒå›¾
    - âœ… è¯¦ç»†çš„ä¸´åºŠå»ºè®®
    - âœ… å…³é”®ç‰¹å¾è§£è¯»
    
    #### ç¬¬å››æ­¥ï¼šä¸´åºŠå†³ç­–
    æ ¹æ®é¢„æµ‹ç»“æœï¼Œç»“åˆæ‚£è€…å®é™…æƒ…å†µï¼š
    - åˆ¶å®šä¸ªæ€§åŒ–æ²»ç–—æ–¹æ¡ˆ
    - å®‰æ’åˆç†çš„éšè®¿è®¡åˆ’
    - è¿›è¡Œé’ˆå¯¹æ€§çš„å¥åº·æ•™è‚²
    - å®æ–½é¢„é˜²æ€§å¹²é¢„æªæ–½
    
    ---
    
    ### æ¨¡å‹æ€§èƒ½æŒ‡æ ‡
    
    æœ¬æ¨¡å‹åœ¨å¤šä¸ªæ•°æ®é›†ä¸Šè¿›è¡Œäº†ä¸¥æ ¼éªŒè¯ï¼š
    
    | æ•°æ®é›† | Micro-AUC | Macro-AUC | æ ·æœ¬é‡ |
    |--------|-----------|-----------|--------|
    | è®­ç»ƒé›† | 1.000 | 1.000 | 908ä¾‹ |
    | æµ‹è¯•é›† | 0.974 | 0.972 | 389ä¾‹ |
    | æ—¶æ®µéªŒè¯é›† | 0.958 | 0.940 | 239ä¾‹ |
    
    **æ€§èƒ½è¯„ä»·ï¼š**
    - è®­ç»ƒé›†è¡¨ç°å®Œç¾ï¼Œè¯´æ˜æ¨¡å‹æ‹Ÿåˆè‰¯å¥½
    - æµ‹è¯•é›†å’Œæ—¶æ®µéªŒè¯é›†AUCå‡>0.94ï¼Œè¯´æ˜æ³›åŒ–èƒ½åŠ›å¼º
    - Micro-AUCå’ŒMacro-AUCæ¥è¿‘ï¼Œè¯´æ˜å¯¹å„äºšå‹é¢„æµ‹å‡è¡¡
    
    ---
    
    ### ç‰¹å¾è·å–æŒ‡å—
    
    #### ç†åŒ–æŒ‡æ ‡å¦‚ä½•è·å–ï¼š
    
    1. **å¹³å‡è¡€çº¢è›‹ç™½é‡ (MCH)**
       - æ¥æºï¼šè¡€å¸¸è§„æ£€æŸ¥
       - è‹±æ–‡åï¼šMean Corpuscular Hemoglobin
       - å•ä½ï¼špg (çš®å…‹)
       - æ£€æŸ¥è¦æ±‚ï¼šç©ºè…¹æˆ–éç©ºè…¹å‡å¯
    
    2. **è½½è„‚è›‹ç™½A (ApoA)**
       - æ¥æºï¼šè¡€è„‚æ£€æŸ¥
       - è‹±æ–‡åï¼šApolipoprotein A
       - å•ä½ï¼šg/L
       - æ£€æŸ¥è¦æ±‚ï¼šå»ºè®®ç©ºè…¹8-12å°æ—¶
    
    3. **å°¿é…¸**
       - æ¥æºï¼šç”ŸåŒ–æ£€æŸ¥
       - è‹±æ–‡åï¼šUric Acid (UA)
       - å•ä½ï¼šÎ¼mol/L
       - æ£€æŸ¥è¦æ±‚ï¼šå»ºè®®ç©ºè…¹
    
    4. **FVCå é¢„è®¡å€¼çš„ç™¾åˆ†æ¯”**
       - æ¥æºï¼šè‚ºåŠŸèƒ½æ£€æŸ¥
       - è‹±æ–‡åï¼šFVC % predicted
       - å•ä½ï¼š%
       - æ£€æŸ¥è¦æ±‚ï¼šåœç”¨æ”¯æ°”ç®¡æ‰©å¼ å‰‚4-6å°æ—¶
    
    #### ä¸­åŒ»è¯å€™å¦‚ä½•åˆ¤æ–­ï¼š
    
    1. **å‘çƒ­**
       - ä½“æ¸©å‡é«˜
       - æ‚£è€…è‡ªè¿°å‘çƒ­æ„Ÿ
       - ä¼´æœ‰æ¶å¯’ã€å‡ºæ±—ç­‰ç—‡çŠ¶
    
    2. **ç—°çƒ­å£…è‚ºè¯**
       - éœ€è¦ç”±ä¸­åŒ»å¸ˆè¿›è¡Œè¾¨è¯
       - ä¸»ç—‡ï¼šå’³å—½ï¼Œå–˜æ¯ï¼Œèƒ¸é—·ï¼Œç—°å¤šã€è‰²é»„ï¼Œå’¯ç—°ä¸çˆ½ï¼ŒèˆŒè´¨çº¢ï¼ŒèˆŒè‹”é»„ï¼ŒèˆŒè‹”è…»ï¼Œè„‰æ•°ï¼Œè„‰æ»‘
       - æ¬¡ç—‡ï¼šç—°é»ï¼Œèƒ¸ç—›ï¼Œå‘çƒ­ï¼Œå£æ¸´å–œå†·é¥®ï¼Œå¤§ä¾¿å¹²ç»“ï¼ŒèˆŒè‹”åš
       - è¯Šæ–­ï¼šâ‘ å’³å—½æˆ–å–˜æ¯ï¼›â‘¡ç—°é»ã€è‰²é»„ï¼Œå’¯ç—°ä¸çˆ½ï¼›â‘¢å‘çƒ­æˆ–å£æ¸´å–œå†·é¥®ï¼›â‘£å¤§ä¾¿å¹²ç»“ï¼›â‘¤èˆŒè´¨çº¢ï¼ŒèˆŒè‹”é»„æˆ–é»„è…»æˆ–é»„åšè…»ï¼Œè„‰æ•°æˆ–æ»‘æ•°ã€‚å…·å¤‡â‘ ã€â‘¡2é¡¹ï¼ŒåŠ â‘¢ã€â‘£ã€â‘¤ä¸­çš„2é¡¹
       - å¦‚æ— ä¸­åŒ»å¸ˆï¼Œå¯å‚è€ƒä¸Šè¿°æ ‡å‡†åˆæ­¥åˆ¤æ–­[å¼•ç”¨æ¥æºï¼šæå»ºç”Ÿç­‰. ä¸­åä¸­åŒ»è¯æ‚å¿—, 2010.25(7):971-975]
    
    ---
    
    ### æŠ€æœ¯æ”¯æŒ
    
    å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
    - ğŸ“§ é‚®ç®±ï¼š[wangj1758@163.com]
    - ğŸ“± ç”µè¯ï¼š[1573196323]
    - ğŸ¥ ç§‘å®¤ï¼š[å‘¼å¸ç§‘]
    """)

# æ¨¡å‹ä¿¡æ¯
st.sidebar.markdown("---")
st.sidebar.info("""
**æ¨¡å‹ä¿¡æ¯**
- **æ¨¡å‹ç±»å‹**ï¼šStackingé›†æˆå­¦ä¹ 
- **åŸºå­¦ä¹ å™¨**ï¼šRF, XGB, LGBM, GBM, AdaBoost, CatBoost
- **å…ƒå­¦ä¹ å™¨**ï¼šLogistic Regression
- **ç‰¹å¾æ•°é‡**ï¼š6ä¸ªå…³é”®ç‰¹å¾
  - ç†åŒ–æŒ‡æ ‡ï¼š4é¡¹
  - ä¸­åŒ»è¯å€™ï¼š2é¡¹
- **é¢„æµ‹ç±»åˆ«**ï¼š4ä¸ªäºšå‹
- **æ€§èƒ½æŒ‡æ ‡**ï¼š
  - æµ‹è¯•é›†AUC: 0.974
  - æ—¶æ®µéªŒè¯é›†AUC: 0.958
""")

# å¿«é€Ÿå‚è€ƒå¡ç‰‡
st.sidebar.markdown("---")
st.sidebar.success("""
**å¿«é€Ÿå‚è€ƒ**

ğŸ”´ **é«˜é£é™© (äºšå‹1)**
- å†ä½é™¢ç‡ï¼š19.2%
- ç‰¹å¾ï¼šå‘çƒ­(+) + ç—°çƒ­å£…è‚ºè¯(+)
- å»ºè®®ï¼š2-4å‘¨éšè®¿

ğŸŸ¡ **ä¸­ç­‰é£é™© (äºšå‹2/3)**
- å†ä½é™¢ç‡ï¼š14-14.5%
- å»ºè®®ï¼š1-2æœˆéšè®¿

ğŸŸ¢ **ä½é£é™© (äºšå‹4)**
- å†ä½é™¢ç‡ï¼š10.1%
- ç‰¹å¾ï¼šå‘çƒ­(-) + ç—°çƒ­å£…è‚ºè¯(+)
- å»ºè®®ï¼š3-6æœˆéšè®¿
""")

# é¡µè„š
st.markdown("---")
st.markdown("""
<div style='text-align: center'>
    <p><strong>âš•ï¸ AECOPDäºšå‹é¢„æµ‹ç³»ç»Ÿ (6ç‰¹å¾ç²¾ç®€ç‰ˆ)</strong></p>
    <p>åŸºäºæœºå™¨å­¦ä¹ çš„ä¸´åºŠå†³ç­–æ”¯æŒå·¥å…·</p>
    <p style='font-size: 12px; color: gray; margin-top: 10px;'>
        <strong>å…è´£å£°æ˜ï¼š</strong>æœ¬ç³»ç»Ÿä»…ä¾›ç ”ç©¶å’Œè¾…åŠ©å†³ç­–ä½¿ç”¨ï¼Œä¸èƒ½æ›¿ä»£ä¸“ä¸šåŒ»ç–—å»ºè®®ã€‚<br>
        æ‰€æœ‰é¢„æµ‹ç»“æœåº”ç”±ä¸“ä¸šåŒ»ç”Ÿç»“åˆä¸´åºŠå®é™…æƒ…å†µè¿›è¡Œç»¼åˆåˆ¤æ–­ã€‚
    </p>
    <p style='font-size: 10px; color: gray; margin-top: 5px;'>
        ç‰ˆæœ¬: 1.0  | æ›´æ–°æ—¥æœŸ: 2025-01-20 | ç‰¹å¾æ•°: 6ä¸ªå…³é”®ç‰¹å¾
    </p>
</div>
""", unsafe_allow_html=True)